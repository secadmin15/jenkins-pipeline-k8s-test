node {
    def app
    stage ('clone repository') {
        checkout scm
    }
    stage ('Build Image') {
       app = docker.build("secadmin15/labuser")
    }
    stage ('Test Image') {
        app.inside {
            sh 'echo "Test Passed"'
        }
    }
    stage ('Hardening scripts') {
        sh 'chmod +x validation.sh'
	//sh 'chmod +x ./validation.sh'
        sh "./validation.sh > out.txt"
        script {
            myVar = readFile('out.txt').trim()
        }
        echo "${myVar}"
        echo "Please find the checks and score below"
        sh 'echo `cat /jobsdata/stdout.txt | tail -n3 |  cut -d " " -f 2,3` '
    }
	stage('Push Image to JFrog') {
                    if (myVar == '>>>>> SUCCESS!!! <<<<') {
                        echo 'CIS Validation SUCCESS - Image To Be Pushed Now To DockerHub'
                        rtDockerPush(
			serverId: "mohammed-test-repo",
			image: "http://ec2-43-204-10-182.ap-south-1.compute.amazonaws.com:8082/mohammed-test-repo/secadmin15/labuser:latest",
			host: 'tcp://0.0.0.0:0',
			targetRepo: 'http://ec2-43-204-10-182.ap-south-1.compute.amazonaws.com:8082/artifactory/mohammed-test-repo/', // where to copy to (from docker-virtual)
			// Attach custom properties to the published artifacts:
			properties: 'project-name=docker1;status=stable'
							)
                            } else {
                        echo 'Push Image FAILED As CIS Score Not Achieved'
                            }
   //stage('Push Image to DockerHub') {
       //steps {
            //script {
               //if (env.STATUS == 'SUCCESS1') {
                    //if (myVar == '>>>>> SUCCESS!!! <<<<') {
                      //  echo 'CIS Validation SUCCESS - Image To Be Pushed Now To DockerHub'
                        //docker.withRegistry('https://registry.hub.docker.com', 'dockerhub_secadmin') {
                          //     app.push("${env.BUILD_NUMBER}")
                        //}
                          //  } else {
                        //echo 'Push Image FAILED As CIS Score Not Achieved'
                          //  }
                        //}
               //}
    //}
         
   // stage('Push image') {
     //   when {
       //   expression { myVar == 'success' }
        // }
        // echo "what am i doing here"            
    // }
}
}
